---
import ThemeSwitcher from "~/components/theme-switcher.astro";
import type { NavItem } from "~/types";
import matiaLogo from "~/assets/matia-logo.png";

// روابط رأس الصفحة (نحدّث المقاطع لاحقًا لكن نحافظ على المراسي الحالية)
const navItems: Array<NavItem> = [
  { title: "الخدمات", url: "#features" },
  { title: "التقييمات", url: "#compatibility" },
  { title: "المعرض", url: "#showcase" },
];

// بيانات التواصل الثابتة
const PHONE = "+966550140714";
const WHATSAPP = "https://wa.me/966550140714";
const MAPS =
  "https://www.google.com/maps/search/?api=1&query=R42V%2BF56%2C%20Jeddah%2023832";
---

<header
  id="page-header"
  class="absolute bottom-0 z-20 flex w-full items-center justify-between border-b border-transparent px-6 py-4 text-white sm:px-8"
>
  <a
    class="flex items-center gap-3 hover:!text-default"
    href="#"
    aria-label="العودة للأعلى"
  >
    <img
      src={matiaLogo.src}
      alt="MATIA SPA®"
      class="hidden h-8 w-auto sm:block"
      loading="eager"
    />
    <span class="font-semibold tracking-wide text-lg sm:text-xl"
      >MATIA SPA®</span
    >
  </a>

  <div>
    <div class="flex items-center gap-4 sm:gap-6">
      <!-- روابط سطح المكتب -->
      <nav class="hidden sm:block">
        <ul class="flex items-center gap-6">
          {
            navItems.map(({ title, url }) => (
              <li>
                <a class="text-sm" href={url} aria-label={title}>
                  {title}
                </a>
              </li>
            ))
          }
        </ul>
      </nav>

      <!-- أزرار اتصال سريعة -->
      <div class="hidden items-center gap-2 lg:flex">
        <a
          href={`tel:${PHONE}`}
          class="bg-[var(--color-secondary)]/90 rounded-full px-4 py-2 text-white text-sm hover:opacity-95 focus:outline-none focus:ring"
          aria-label="اتصلي بنا"
        >
          اتصال
        </a>
        <a
          href={WHATSAPP}
          target="_blank"
          rel="noopener"
          class="rounded-full bg-[var(--color-primary)] px-4 py-2 text-white text-sm hover:opacity-95 focus:outline-none focus:ring"
          aria-label="تواصلي عبر واتساب"
        >
          واتساب
        </a>
      </div>

      <button
        id="open-nav-button"
        type="button"
        class="btn sm:hidden"
        aria-label="القائمة"
      >
        <!-- أيقونة همبرغر بسيطة -->
        <svg
          class="size-8"
          viewBox="0 0 24 24"
          fill="currentColor"
          aria-hidden="true"
        >
          <path
            d="M3 6h18M3 12h18M3 18h18"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"></path>
        </svg>
      </button>

      <ThemeSwitcher />
    </div>

    <!-- قائمة الجوال -->
    <div id="menu-modal" class="modal hidden" aria-hidden="true">
      <div class="fixed inset-0 bg-default px-6 py-4 text-default sm:px-8">
        <div class="space-y-4" role="dialog" aria-modal="true">
          <header class="flex justify-end">
            <button
              id="close-nav-button"
              type="button"
              class="btn"
              aria-label="إغلاق القائمة"
            >
              <svg
                class="size-8"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                aria-hidden="true"><path d="M6 6l12 12M6 18L18 6"></path></svg
              >
            </button>
          </header>
          <div class="flex justify-center">
            <img src={matiaLogo.src} alt="MATIA SPA®" class="h-16 w-auto" />
          </div>
          <nav>
            <ul class="flex flex-col">
              {
                navItems.map(({ title, url }) => (
                  <li>
                    <a
                      class="block py-4 text-center text-xl"
                      href={url}
                      aria-label={title}
                    >
                      {title}
                    </a>
                  </li>
                ))
              }
            </ul>
          </nav>
          <div class="grid grid-cols-2 gap-3 pt-2">
            <a
              href={`tel:${PHONE}`}
              class="rounded-full bg-[var(--color-secondary)] px-4 py-3 text-center text-white"
              >اتصال</a
            >
            <a
              href={WHATSAPP}
              target="_blank"
              rel="noopener"
              class="rounded-full bg-[var(--color-primary)] px-4 py-3 text-center text-white"
              >واتساب</a
            >
            <a
              href={MAPS}
              target="_blank"
              rel="noopener"
              class="col-span-2 rounded-full border border-[var(--color-border)] px-4 py-3 text-center"
              >اتجهي إلينا</a
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  import MicroModal from "micromodal";
  import invariant from "tiny-invariant";

  const menuModalId = "menu-modal";

  const header = document.querySelector("#page-header");
  const page = document.documentElement;
  const menu = document.querySelector(`#${menuModalId} ul`);
  const openNavButton = document.querySelector("#open-nav-button");
  const closeNavButton = document.querySelector("#close-nav-button");

  invariant(header, "header should not be null");
  invariant(menu, "menu should not be null");
  invariant(openNavButton, "openNavButton should not be null");
  invariant(closeNavButton, "closeNavButton should not be null");

  const openMenu = () => {
    MicroModal.show(menuModalId, { disableScroll: true });
  };

  const closeMenu = () => {
    MicroModal.close(menuModalId);
  };

  openNavButton.addEventListener("click", openMenu);
  closeNavButton.addEventListener("click", closeMenu);

  document.addEventListener("scroll", () => {
    const d = page.clientHeight - page.scrollTop - header.offsetHeight;
    header.classList.toggle("fixed-header", d < 0);
  });

  menu.addEventListener("click", (event) => {
    if (event.target.tagName === "A") {
      closeMenu();
    }
  });
</script>

<noscript>
  <style>
    #open-nav-button {
      display: none;
    }
  </style>
</noscript>

<style>
  .fixed-header {
    @apply fixed bottom-auto top-0;
    @apply border-default bg-default text-default;
  }
  .modal.is-open {
    @apply block;
  }
</style>
